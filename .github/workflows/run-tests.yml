name: Run Auto Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
    - run: npm ci
    - run: npx playwright install --with-deps chromium
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º UI —Ç–µ—Å—Ç—ã
    - name: üß™ Run UI tests
      run: npx playwright test tests/UI/specs/ --project=ui-tests
      continue-on-error: true
      
    # –ó–∞–ø—É—Å–∫–∞–µ–º API —Ç–µ—Å—Ç—ã  
    - name: üß™ Run API tests
      run: npx playwright test tests/API/specs/ --project=api-tests
      continue-on-error: true
    
    # ‚úÖ Allure TestOps –∑–∞–≥—Ä—É–∑–∫–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
    - name: Install allurectl
      if: always()
      uses: allure-framework/setup-allurectl@v1
      with:
        allure-endpoint: ${{ secrets.ALLURE_ENDPOINT }}
        allure-token: ${{ secrets.ALLURE_TOKEN }}
        allure-project-id: ${{ secrets.ALLURE_PROJECT_ID }}
    
    - name: Upload results to Allure TestOps
      if: always()
      run: allurectl upload allure-results
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
    - name: Send Telegram notification
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üéì **Diploma Project: Sauce Demo**
          
          ‚úÖ **Tests completed!**
          
          üìä Status: ${{ job.status }}
          üåø Branch: ${{ github.ref_name }}
          üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}